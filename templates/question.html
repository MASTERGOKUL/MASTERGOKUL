<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ChatWithQA - Question {{ question_number }}</title>
    <link rel="stylesheet" href="../static/css/style.css" />
  </head>
  <body>
    <div class="center">
      <h1>Question {{ question_number }} / 3</h1>
      <img src="../static/img/female2.jpg" alt="" id="female2" />
      <h3>{{ question_text }}</h3>
      <audio autoplay>
        <source
          src="{{url_for('static',filename=audio_file_name)}}"
          type="audio/mp3"
        />
      </audio>
    <audio id="audio-element"></audio>
      <form method="post" id="questionForm">
        <button id="record">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            height="1em"
            viewBox="0 0 384 512"
            id="mic"
          >
            <!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
            <path
            fill="#AB5D84"
              d="M192 0C139 0 96 43 96 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"
            />
          </svg>
        </button>
        <label for="answer">Or</label>
        <input type="text" placeholder="Type Your Answer" id="answer" name="answer" required />
        <input
          type="hidden"
          id="audio_file"
          name="played_audio_file"
          value="{{audio_file_name}}"
        />
        <input
          type="hidden"
          id="responses"
          name="responses"
          value="{{responses}}"
        />

        <button type="submit" class="btn">Next</button>
      </form>
    </div>

  </body>
    <script>
         // View
        var recordingButton = document.getElementById("record");

        var audioElementSource = document.getElementById("audio-element");
        var audioElement = document.getElementById("audio-element");
        // Listeners

        // Listen to mouse down event on the recording button
        recordingButton.addEventListener("mousedown", startRecording);
        recordingButton.addEventListener("touchstart", startRecording);
        // Listen to mouse up event on the recording button
        recordingButton.addEventListener("mouseup", stopRecording);
        recordingButton.addEventListener("touchend", stopRecording);
        // Variables
        var isRecording = false;
        var audioRecordStartTime; // Added variable

        // Functions

        /** Handles starting the audio recording when the button is pressed */
        function startRecording() {
            if (!isRecording) {
                isRecording = true;
                startAudioRecording();
            }
        }

        /** Handles stopping the audio recording when the button is released */
        function stopRecording() {
            if (isRecording) {
                isRecording = false;
                stopAudioRecording();
            }
        }

        //API to handle audio recording

        var audioRecorder = {
            audioBlobs: [],
            mediaRecorder: null,
            streamBeingCaptured: null,
            start: function () {
                // Feature Detection
                if (!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)) {
                    return Promise.reject(new Error('mediaDevices API or getUserMedia method is not supported in this browser.'));
                }

                return navigator.mediaDevices.getUserMedia({ audio: true })

                    .then(stream => {
                        this.streamBeingCaptured = stream;
                        this.mediaRecorder = new MediaRecorder(stream);
                        this.audioBlobs = [];

                        this.mediaRecorder.addEventListener("dataavailable", event => {
                            this.audioBlobs.push(event.data);
                        });

                        // Store the recording start time
                        audioRecordStartTime = new Date();

                        this.mediaRecorder.start();
                    });
            },
            stop: function () {
                return new Promise(resolve => {
                    let mimeType = this.mediaRecorder.mimeType;

                    this.mediaRecorder.addEventListener("stop", () => {
                        let audioBlob = new Blob(this.audioBlobs, { type: mimeType });
                        resolve(audioBlob);
                    });
                    this.cancel();
                });
            },
            cancel: function () {
                this.mediaRecorder.stop();
                this.stopStream();
                this.resetRecordingProperties();
            },
            stopStream: function () {
                this.streamBeingCaptured.getTracks().forEach(track => track.stop());
            },
            resetRecordingProperties: function () {
                this.mediaRecorder = null;
                this.streamBeingCaptured = null;
            }
        };

        function playAudio(recorderAudioAsBlob) {
            let reader = new FileReader();

            reader.onload = (e) => {
                let base64URL = e.target.result;

                if (!audioElementSource)
                    createSourceForAudioElement();

                audioElementSource.src = base64URL;

                let BlobType = recorderAudioAsBlob.type.includes(";") ?
                    recorderAudioAsBlob.type.substr(0, recorderAudioAsBlob.type.indexOf(';')) : recorderAudioAsBlob.type;
                audioElementSource.type = BlobType

                audioElement.load();
                audioElement.play();
            };

            reader.readAsDataURL(recorderAudioAsBlob);
        }

        function startAudioRecording() {
            console.log("Recording Audio...");

            audioRecorder.start()
                .then(() => {
                    handleDisplayingRecordingControlButtons();
                })
                .catch(error => {
                    if (error.message.includes("mediaDevices API or getUserMedia method is not supported in this browser.")) {
                        console.log("To record audio, use browsers like Chrome and Firefox.");
                    }

                    switch (error.name) {
                        // Error handling structure...
                    };
                });
        }

        function stopAudioRecording() {
            console.log("Stopping Audio Recording...");

            audioRecorder.stop()
                .then(audioAsblob => {
                    playAudio(audioAsblob);
                    // Convert the Blob to FormData
                      const formData = new FormData();
                      formData.append('audio', audioAsblob, 'audio.wav'); // adjust the filename and MIME type accordingly

                      // Make a POST request to Flask endpoint
                      fetch('/submit-audio', {
                          method: 'POST',
                          body: formData
                      })
                      .then(response => response.json())
                      .then(data => {
                          console.log('Audio submitted successfully:', data);
                          // Add any additional logic or UI updates after successful submission
                      })
                      .catch(error => {
                          console.error('Error submitting audio:', error);
                          // Handle errors or provide user feedback
                      });
                })
                .catch(error => {
                    console.log(error);
                });
        }

        function createSourceForAudioElement() {
            let sourceElement = document.createElement("source");
            audioElement.appendChild(sourceElement);
            audioElementSource = sourceElement;
        }
    </script>
</html>
